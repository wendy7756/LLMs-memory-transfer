name: Release and Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate userscript
      run: |
        # éªŒè¯è„šæœ¬è¯­æ³•
        node -c llm-memory-transfer.user.js
        
        # æ£€æŸ¥ç‰ˆæœ¬å·ä¸€è‡´æ€§
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        SCRIPT_VERSION=$(grep -o '@version.*' llm-memory-transfer.user.js | cut -d' ' -f2 | tr -d ' ')
        
        if [ "$PACKAGE_VERSION" != "$SCRIPT_VERSION" ]; then
          echo "ç‰ˆæœ¬å·ä¸ä¸€è‡´: package.json($PACKAGE_VERSION) vs userscript($SCRIPT_VERSION)"
          exit 1
        fi
        
        echo "ç‰ˆæœ¬éªŒè¯é€šè¿‡: $PACKAGE_VERSION"
        
    - name: Extract version
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Generate changelog
      id: changelog
      run: |
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        if [ -f CHANGELOG.md ]; then
          CHANGELOG=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1)
        else
          CHANGELOG="è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹commitå†å²"
        fi
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: LLM Memory Transfer v${{ steps.version.outputs.version }}
        body: |
          ## ğŸš€ LLM Memory Transfer v${{ steps.version.outputs.version }}
          
          ### å®‰è£…æ–¹æ³•
          
          **è‡ªåŠ¨å®‰è£…ï¼ˆæ¨èï¼‰:**
          - [ä» Greasy Fork å®‰è£…](https://greasyfork.org/zh-CN/scripts/XXX-llm-memory-transfer)
          - [ç›´æ¥å®‰è£… (.user.js)](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/llm-memory-transfer.user.js)
          
          **æ‰‹åŠ¨å®‰è£…:**
          1. å¤åˆ¶è„šæœ¬å†…å®¹
          2. åœ¨Tampermonkeyä¸­åˆ›å»ºæ–°è„šæœ¬
          3. ç²˜è´´å¹¶ä¿å­˜
          
          ### æ›´æ–°å†…å®¹
          
          ${{ steps.changelog.outputs.changelog }}
          
          ### æ”¯æŒçš„ç½‘ç«™
          - âœ… ChatGPT (chat.openai.com, chatgpt.com) 
          - âœ… Claude (claude.ai)
          - âœ… Gemini (gemini.google.com)
          
          ### æ–‡æ¡£
          - ğŸ“– [å®‰è£…æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/docs/INSTALL.md)
          - ğŸ”§ [ä½¿ç”¨è¯´æ˜](https://github.com/${{ github.repository }}/blob/main/README.md)
          - â“ [å¸¸è§é—®é¢˜](https://github.com/${{ github.repository }}/blob/main/docs/FAQ.md)
          
        files: |
          llm-memory-transfer.user.js
        draft: false
        prerelease: false

  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate JavaScript syntax
      run: |
        # éªŒè¯JavaScriptè¯­æ³•
        node -c llm-memory-transfer.user.js
        echo "âœ… JavaScriptè¯­æ³•éªŒè¯é€šè¿‡"
        
    - name: Check Tampermonkey headers
      run: |
        # éªŒè¯Tampermonkeyå¤´éƒ¨ä¿¡æ¯
        if ! grep -q "// ==UserScript==" llm-memory-transfer.user.js; then
          echo "âŒ ç¼ºå°‘UserScriptå¤´éƒ¨"
          exit 1
        fi
        
        if ! grep -q "// ==/UserScript==" llm-memory-transfer.user.js; then
          echo "âŒ UserScriptå¤´éƒ¨æœªæ­£ç¡®é—­åˆ"
          exit 1
        fi
        
        # æ£€æŸ¥å¿…éœ€çš„metadata
        REQUIRED_FIELDS=("@name" "@version" "@description" "@match")
        for field in "${REQUIRED_FIELDS[@]}"; do
          if ! grep -q "$field" llm-memory-transfer.user.js; then
            echo "âŒ ç¼ºå°‘å¿…éœ€å­—æ®µ: $field"
            exit 1
          fi
        done
        
        echo "âœ… Tampermonkeyå¤´éƒ¨éªŒè¯é€šè¿‡" 